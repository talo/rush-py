mutation cancel_module_instance($moduleInstanceId: ModuleInstanceId!) {
  cancel(instance: $moduleInstanceId)
}
mutation delete_module_instance($moduleInstanceId: ModuleInstanceId!) {
    delete_module_instance(module: $moduleInstanceId) { id }
}
mutation deploy($module: ModuleInput!) {
  deploy(module: $module) {
    id
    path
  }
}
mutation create_entity($entity: RawEntityInput!) {
  create_entity(entity: $entity) {
    id
  }
}
mutation create_experiment($experiment: CreateExperimentInput!) {
  create_experiment(input: $experiment) {
    id
  }
}
mutation create_project($project: CreateProjectInput!) {
  create_project(input: $project) {
    id
  }
}
mutation create_protein($protein: CreateProteinInput!) {
  create_protein(input: $protein) {
    id
  }
}
mutation create_protein_conformer(
  $protein_conformer: CreateProteinConformerInput!
) {
  create_protein_conformer(input: $protein_conformer) {
    id
  }
}
# Common Fragments across all queries
fragment PageInfoFull on PageInfo {
  hasPreviousPage
  hasNextPage
  startCursor
  endCursor
}

## Arguments fragments and queries
fragment ArgumentFull on Argument {
  id
  name
  typeinfo
  value
  created_at
  rejected_at
  source
  tags
}

query argument($id: ArgumentId!) {
  argument(id: $id) {
    ...ArgumentFull
  }
}

query arguments(
  $after: String
  $before: String
  $first: Int
  $last: Int
  $typeinfo: [Type!]
  $tags: [String!]
  $resolved: Boolean
) {
  me {
    account {
      arguments(
        first: $first
        last: $last
        after: $after
        before: $before
        typeinfo: $typeinfo
        tags: $tags
        resolved: $resolved
      ) {
        pageInfo {
          ...PageInfoFull
        }
        edges {
          cursor
          node {
            ...ArgumentFull
          }
        }
      }
    }
  }
}

## Module fragments and queries

fragment ModuleFull on Module {
  id
  name
  created_at
  deleted_at
  path
  usage
  ins
  ins_usage
  outs
  outs_usage
  description
  typedesc
  tags
  targets
  resource_bounds {
    gpu_min
    gpu_max
    gpu_hint

    gpu_mem_min
    gpu_mem_max
    gpu_mem_hint

    cpu_min
    cpu_max
    cpu_hint
    node_min
    node_max
    node_hint

    mem_min
    mem_max

    storage_min
    storage_max
  }
}

query latest_modules(
  $after: String
  $before: String
  $first: Int
  $last: Int
  $order: OrderBy
  $names: [String!]
) {
  latest_modules(
    after: $after
    before: $before
    first: $first
    last: $last
    order: $order
    names: $names
  ) {
    pageInfo {
      ...PageInfoFull
    }
    edges {
      cursor
      node {
        ...ModuleFull
      }
    }
  }
}

query modules(
  $after: String
  $before: String
  $first: Int
  $last: Int
  $path: String
  $tags: [String!]
) {
  modules(
    first: $first
    last: $last
    after: $after
    before: $before
    path: $path
    tags: $tags
  ) {
    pageInfo {
      ...PageInfoFull
    }
    edges {
      cursor
      node {
        ...ModuleFull
      }
    }
  }
}

## ModuleInstance fragments and queries

fragment ModuleInstanceCommon on ModuleInstance {
  id
  account_id
  name

  created_at
  deleted_at
  queued_at
  admitted_at
  dispatched_at
  completed_at

  path
  status
  target
  tags

  failure_reason
  failure_context {
    stdout
    stderr
    syserr
  }
}

fragment SimpleModuleInstanceCommon on SimpleModuleInstance {
  id
  account_id

  created_at
  deleted_at
  queued_at
  admitted_at
  dispatched_at
  completed_at

  path
  status
  target
  tags

  failure_reason
  failure_context {
    stdout
    stderr
    syserr
  }
}

fragment ModuleInstanceFull on ModuleInstance {
  ...ModuleInstanceCommon
  ins {
    id
    created_at
    deleted_at
    rejected_at
    account_id
    typeinfo
    value
    tags
  }
  outs {
    id
    created_at
    deleted_at
    rejected_at
    account_id
    typeinfo
    value
    tags
  }
  resources {
    gpus
    nodes
    mem
    storage
    walltime
  }
  progress {
    n
    n_expected
    n_max
    done
  }
}

fragment SimpleModuleInstanceFull on SimpleModuleInstance {
  ...SimpleModuleInstanceCommon
  ins {
    id
    created_at
    deleted_at
    rejected_at
    account_id
    typeinfo
    value
    tags
  }
  outs {
    id
    created_at
    deleted_at
    rejected_at
    account_id
    typeinfo
    value
    tags
  }
  resources {
    gpus
    nodes
    mem
    storage
    walltime
  }
  progress {
    n
    n_expected
    n_max
    done
  }
}

query module_instance_details(
  $id: ModuleInstanceId!
  $stderr_after: String
  $stderr_before: String
  $stdout_after: String
  $stdout_before: String
) {
  module_instance(id: $id) {
    ...ModuleInstanceFull
    stdout(after: $stdout_after, before: $stdout_before) {
      pageInfo {
        ...PageInfoFull
      }
      edges {
        cursor
        node {
          id
          created_at
          content
        }
      }
    }
    stderr(after: $stderr_after, before: $stderr_before) {
      pageInfo {
        ...PageInfoFull
      }
      edges {
        cursor
        node {
          id
          created_at
          content
        }
      }
    }
  }
}

query module_instances(
  $after: String
  $before: String
  $first: Int
  $last: Int
  $path: String
  $name: String
  $status: ModuleInstanceStatus
  $tags: [String!]
  $ids: [ModuleInstanceId!]
  $in_argument_ids: [ArgumentId!]
) {
  me {
    account {
      module_instances(
        first: $first
        last: $last
        after: $after
        before: $before
        path: $path
        status: $status
        name: $name
        tags: $tags
        ids: $ids
        in_arguments: $in_argument_ids
      ) {
        edges {
          cursor
          node {
            ...SimpleModuleInstanceFull
          }
        }
        pageInfo {
          ...PageInfoFull
        }
      }
    }
  }
}

query module_instance_minimal($id: ModuleInstanceId!) {
  module_instance(id: $id) {
    ...ModuleInstanceCommon
  }
}

query object($id: ArgumentId!) {
  object(id: $id)
}

## Raw Entity (v2)

query entity($id: UUID!) {
  entity(id: $id) {
    id
    createdAt
    updatedAt
    deletedAt
    data
    tags
  }
}

## Project

query project($id: UUID!) {
  project(id: $id) {
    createdAt
    updatedAt
    deletedAt
    data {
      name
    }
    tags
    proteins {
      edges {
        node {
          id
        }
      }
    }
    protein_conformers {
      edges {
        node {
          id
        }
      }
    }
    smols {
      edges {
        node {
          id
        }
      }
    }
    smol_conformers {
      edges {
        node {
          id
        }
      }
    }
    smol_tautomers {
      edges {
        node {
          id
        }
      }
    }
  }
}

query protein($id: UUID!) {
  protein(id: $id) {
    id
    createdAt
    updatedAt
    deletedAt
    data {
      name
      sequence
    }
    tags
  }
}

query protein_conformer($id: UUID!) {
  protein_conformer(id: $id) {
    id
    createdAt
    updatedAt
    deletedAt
    data {
      name
    }
    tags
  }
}

query smol($id: UUID!) {
  smol(id: $id) {
    id
    createdAt
    updatedAt
    deletedAt
    data {
      name
      inchi
    }
    tags
  }
}

query smol_conformer($id: UUID!) {
  smol_conformer(id: $id) {
    id
    createdAt
    updatedAt
    deletedAt
    data {
      name
    }
    tags
  }
}

query smol_tautomer($id: UUID!) {
  smol_tautomer(id: $id) {
    id
    createdAt
    updatedAt
    deletedAt
    data {
      name
      inchi
    }
    tags
  }
}

query structure($id: UUID!) {
  structure(id: $id) {
    id
    createdAt
    updatedAt
    deletedAt
    data {
      name
    }
    topology {
      symbols
      geometry
      connectivity
      formal_charges
      labels
      partial_charges
      fragments
      fragment_formal_charges
      fragment_partial_charges
      velocities
      alts
    }
    # signed_url
    tags
  }
}

query experiment($id: UUID!) {
  experiment(id: $id) {
    id
    createdAt
    updatedAt
    deletedAt
    data {
      name
      unit
      measure
      value
      assay
    }
    tags
  }
}
# Retries a failed module instance
mutation retry(
  $instance: ModuleInstanceId!
  $target: ModuleInstanceTarget!
  $resources: ModuleInstanceResourcesInput
) {
  retry(instance: $instance, target: $target, resources: $resources) {
    id
  }
}
mutation run($instance: ModuleInstanceInput!) {
    run(instance: $instance) {
        id
        outs {id}
    }
}
mutation create_smol($smol: CreateSmolInput!) {
  create_smol(input: $smol) {
    id
  }
}
mutation create_smol_conformer($smol_conformer: CreateSmolConformerInput!) {
  create_smol_conformer(input: $smol_conformer) {
    id
  }
}
mutation create_smol_tautomer($smol_tautomer: CreateSmolTautomerInput!) {
  create_smol_tautomer(input: $smol_tautomer) {
    id
  }
}
mutation create_structure($structure: CreateStructureInput!) {
  create_structure(input: $structure) {
    id
  }
}
mutation tag($moduleInstanceId: ModuleInstanceId, $argumentId: ArgumentId, $moduleId: ModuleId, $tags: [String!]!) {
    tag(module_instance: $moduleInstanceId, argument: $argumentId, module: $moduleId, tags: $tags)
}
mutation track_utilization($utilization: ResourceUtilizationInput!) {
  track_module_instance_resource_utilization(utilization: $utilization) {
    id
  }
}
mutation untag($moduleInstanceId: ModuleInstanceId, $argumentId: ArgumentId, $moduleId: ModuleId, $tags: [String!]!) {
    untag(module_instance: $moduleInstanceId, argument: $argumentId, module: $moduleId, tags: $tags)
}
mutation update_module_instance(
  $moduleInstanceUpdate: UpdateModuleInstanceInput!
) {
  update_module_instance(instance_update: $moduleInstanceUpdate) {
    id
    status
  }
}
mutation upload_arg($typeinfo: JSON!, $file: Upload!) {
  upload_arg(typeinfo: $typeinfo, file: $file) {
    id
    value
  }
}
